services:
  metron-proxy:
    build:
      context: ./metron_proxy
      dockerfile: Dockerfile
    container_name: metron-proxy
    ports:
      - "8080:8080"
    environment:
      - METRON_USERNAME=${METRON_USERNAME}
      - METRON_PASSWORD=${METRON_PASSWORD}      
      - METRON_PROXY_URL=${PROXY_URL}
      - POCKETBASE_URL=http://pocketbase:8080/
      - REDIS_ADDR=redis-metron-cache:6379
    depends_on:
      - redis-metron-cache
    restart: unless-stopped


  pocketbase:
    build:
      context: ./pocketbase
      dockerfile: Dockerfile
    container_name: pocketbase
    ports:
      - "8090:8080"
    volumes:
      - ./pocketbase/pb_data:/pb/pb_data
      - ./pocketbase/pb_migrations:/pb/pb_migrations
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./config/web:/webconfig
      - ./config/caddy:/etc/caddy
      - caddy_data:/data
      - caddy_config:/config
    restart: unless-stopped

  redis-metron-cache:
    image: redis:7-alpine
    volumes:
      - redis-metron-cache-data:/data
    restart: always
      
volumes:
  redis-metron-cache-data:
  caddy_data:
  caddy_config:
